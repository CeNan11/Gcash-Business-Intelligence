{% extends "base.html" %}

{% block title %}GCash - Version Analytics{% endblock %}

{% block nav_versions %}active{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-white drop-shadow-md">Release Performance</h1>
    <p class="text-blue-100 mt-1 font-medium">Evaluate software quality and technical stability</p>
</div>

<!-- CHART: VERSION LEADERBOARD -->
<div class="dashboard-card p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h3 class="font-bold text-slate-800 text-lg">üèÜ Version Stability Leaderboard</h3>
            <p class="text-xs text-gray-500">Comparing average user rating across recent releases</p>
        </div>
    </div>
    <div class="h-80 w-full">
        <canvas id="versionChart"></canvas>
    </div>
</div>

<!-- TABLE: TECHNICAL DEBT INDEX -->
<div class="dashboard-card overflow-hidden">
    <div class="p-6 border-b border-gray-100 bg-orange-50 flex justify-between items-center">
        <div>
            <h3 class="font-bold text-orange-900 text-lg">‚ö†Ô∏è Technical Stability Index</h3>
            <p class="text-sm text-orange-700 opacity-80">Based on frequency of "Crash", "Lag", "Slow", "Bug"</p>
        </div>
        <div class="bg-white px-3 py-1 rounded-full border border-orange-200 text-xs font-bold text-orange-600">
            Automated Detection
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider">
                <tr>
                    <th class="px-6 py-3">Version</th>
                    <th class="px-6 py-3">Issue Rate (%)</th>
                    <th class="px-6 py-3">Impact (Users)</th>
                    <th class="px-6 py-3">Status</th>
                </tr>
            </thead>
            <tbody id="crashTableBody" class="divide-y divide-gray-100 text-sm">
                <!-- Injected via JS -->
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', fetchVersions);

    async function fetchVersions() {
        try {
            const response = await fetch('/api/versions');
            const data = await response.json();

            if(data.error) {
                alert("Error: " + data.error);
                return;
            }

            // --- 1. Render Bar Chart ---
            const ctx = document.getElementById('versionChart').getContext('2d');
            
            // Dynamic Colors: Green for good versions, Red for bad
            const bgColors = data.rating_chart.data.map(score => 
                score >= 4.0 ? '#22c55e' : (score >= 3.0 ? '#f59e0b' : '#ef4444')
            );

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.rating_chart.labels,
                    datasets: [{
                        label: 'Average Rating',
                        data: data.rating_chart.data,
                        backgroundColor: bgColors,
                        borderRadius: 6,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Rating: ${context.raw} ‚≠ê (${data.rating_chart.counts[context.dataIndex]} reviews)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            min: 1, max: 5,
                            grid: { borderDash: [4, 4] }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });

            // --- 2. Render Crash Table ---
            const tbody = document.getElementById('crashTableBody');
            tbody.innerHTML = '';

            data.crash_data.forEach(row => {
                // Determine Status Badge
                let statusHtml = '';
                let rowClass = '';
                
                if (row.percentage >= 15) {
                    statusHtml = '<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded border border-red-200">CRITICAL</span>';
                    rowClass = 'bg-red-50/50'; // Highlight row slightly
                } else if (row.percentage >= 8) {
                    statusHtml = '<span class="bg-orange-100 text-orange-800 text-xs font-bold px-2 py-1 rounded border border-orange-200">UNSTABLE</span>';
                } else {
                    statusHtml = '<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded border border-green-200">STABLE</span>';
                }

                const html = `
                    <tr class="hover:bg-gray-50 transition ${rowClass}">
                        <td class="px-6 py-4">
                            <span class="font-bold text-gray-700">v${row.version}</span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-24 bg-gray-200 rounded-full h-2 mr-3">
                                    <div class="bg-orange-500 h-2 rounded-full" style="width: ${Math.min(row.percentage, 100)}%"></div>
                                </div>
                                <span class="font-bold text-gray-700">${row.percentage}%</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-gray-600">
                            ${row.count} / ${row.total} reviews
                        </td>
                        <td class="px-6 py-4">
                            ${statusHtml}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += html;
            });

        } catch (e) {
            console.error("Error:", e);
        }
    }
</script>
{% endblock %}